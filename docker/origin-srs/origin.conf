listen              1935;
max_connections     300;
server_id           71;

srs_log_tank        console;
ff_log_dir          ./objs/ffmpeg;
daemon              off;

http_api {
    enabled         on;
    listen          1985;
}

http_server {
    enabled         on;
    listen          8082;
    dir             ./objs/nginx/html;
}

rtc_server {
    enabled off;
}

# Single vhost configuration - handles both ingestion and playback
vhost __defaultVhost__ {
    # Webhook authentication for publishing
    http_hooks {
        enabled         on;
        on_publish      http://127.0.0.1/api/srs/auth;
        on_unpublish    http://127.0.0.1/api/srs/unpublish;
    }

    # HLS output configuration
    hls {
        enabled         on;
        hls_fragment    4;      # 4 seconds = 2 keyframes (keyframes every 2 seconds)
        hls_window      60;
        hls_path        ./objs/nginx/html;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]/[timestamp].ts;  # Use timestamp for consistent naming
        hls_entry_prefix http://localhost:8080;
        hls_dispose     120;
        hls_wait_keyframe on;  # CRITICAL: Wait for keyframe to start segments
        hls_ctx         off;
        hls_ts_ctx      off;
        hls_cleanup     on;     # Clean up old segments
        hls_nb_notify   64;     # Number of notifies for new segments
        hls_acodec      aac;    # Ensure consistent audio codec
        hls_vcodec      h264;   # Ensure consistent video codec
    }

    # FLV disabled - using HLS only
    http_remux {
        enabled     off;
    }

    rtc {
        enabled     off;
    }

    play {
        gop_cache       on;
        mw_latency      1800;
    }

    # Transcode configuration - only applies to "ingress" app
    transcode ingress {
        enabled on;
        ffmpeg      ./objs/ffmpeg/bin/ffmpeg;

        # FHD 1080p - Full HD with high bitrate
        engine fhd {
            enabled on;
            vcodec libx264;
            vbitrate 6000;
            vfps 30;
            vwidth 1920;
            vheight 1080;
            vthreads 4;
            vprofile main;
            vpreset medium;
            vparams {
                # Force keyframe sync for smooth quality switching
                # keyint=60:min-keyint=60 forces keyframes every 60 frames (2 seconds at 30fps)
                # no-scenecut prevents extra keyframes on scene changes
                # force-cfr ensures constant frame rate
                x264opts    keyint=60:min-keyint=60:no-scenecut:force-cfr=1;
                # Rate control for consistent quality
                crf         23;     # Constant Rate Factor for quality
                maxrate     6500k;  # Max bitrate slightly above target
                bufsize     13000k; # Buffer size for rate control
                # Encoding optimizations
                bf          2;      # B-frames for better compression
                refs        3;      # Reference frames
            }
            acodec aac;
            abitrate 192;
            asample_rate 48000;
            achannels 2;
            aparams {
                # Ensure audio sync
                af          aresample=async=1:min_hard_comp=0.100000:first_pts=0;
            }
            # Output to "live" app in same vhost
            output rtmp://127.0.0.1:[port]/live/[stream]_fhd;
        }

        # HD 720p
        engine hd {
            enabled on;
            vcodec libx264;
            vbitrate 3000;
            vfps 30;
            vwidth 1280;
            vheight 720;
            vthreads 2;
            vprofile main;
            vpreset faster;
            vparams {
                # Force keyframe sync for smooth quality switching
                x264opts    keyint=60:min-keyint=60:no-scenecut:force-cfr=1;
                # Rate control
                crf         23;
                maxrate     3500k;
                bufsize     7000k;
                # Encoding optimizations
                bf          2;      # B-frames for better compression
            }
            acodec aac;
            abitrate 160;
            asample_rate 48000;
            achannels 2;
            aparams {
                # Ensure audio sync
                af          aresample=async=1:min_hard_comp=0.100000:first_pts=0;
            }
            # Output to "live" app in same vhost
            output rtmp://127.0.0.1:[port]/live/[stream]_hd;
        }

        # SD 480p
        engine sd {
            enabled on;
            vcodec libx264;
            vbitrate 1500;
            vfps 30;
            vwidth 854;
            vheight 480;
            vthreads 2;
            vprofile baseline;
            vpreset veryfast;
            vparams {
                # Force keyframe sync for smooth quality switching
                x264opts    keyint=60:min-keyint=60:no-scenecut:force-cfr=1;
                # Rate control
                crf         23;
                maxrate     2000k;
                bufsize     4000k;
            }
            acodec aac;
            abitrate 128;
            asample_rate 48000;
            achannels 2;
            aparams {
                # Ensure audio sync
                af          aresample=async=1:min_hard_comp=0.100000:first_pts=0;
            }
            # Output to "live" app in same vhost
            output rtmp://127.0.0.1:[port]/live/[stream]_sd;
        }

        # LD 360p - DISABLED (removed from player)
        engine ld {
            enabled off;
            vcodec libx264;
            vbitrate 500;
            vfps 30;
            vwidth 640;
            vheight 360;
            vthreads 2;
            vprofile baseline;
            vpreset veryfast;
            vparams {
                # Force keyframe sync for smooth quality switching
                x264opts    keyint=60:min-keyint=60:no-scenecut:force-cfr=1;
                # Rate control
                crf         23;
                maxrate     750k;
                bufsize     1500k;
            }
            acodec aac;
            abitrate 64;
            asample_rate 48000;
            achannels 2;
            aparams {
                # Ensure audio sync
                af          aresample=async=1:min_hard_comp=0.100000:first_pts=0;
            }
            # Output to "live" app in same vhost
            output rtmp://127.0.0.1:[port]/live/[stream]_ld;
        }
    }
}
