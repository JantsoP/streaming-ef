listen              1935;
max_connections     300;
server_id           71;

srs_log_tank        console;
ff_log_dir          ./objs/ffmpeg;
daemon              off;

http_api {
    enabled         on;
    listen          1985;
}

http_server {
    enabled         on;
    listen          8082;
    dir             ./objs/nginx/html;
}

rtc_server {
    enabled off;
}

# Single vhost configuration - handles both ingestion and playback
vhost __defaultVhost__ {
    # Webhook authentication for publishing
    http_hooks {
        enabled         on;
        on_publish      http://127.0.0.1/api/srs/auth;
        on_unpublish    http://127.0.0.1/api/srs/unpublish;
    }

    # HLS output configuration
    hls {
        enabled         on;
        hls_fragment    10;
        hls_window      60;
        hls_path        ./objs/nginx/html;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]/[seq].ts;
        hls_entry_prefix http://localhost:8080/;
        hls_dispose     120;
        hls_wait_keyframe off;
        hls_ctx         off;
        hls_ts_ctx      off;
    }

    # FLV disabled - using HLS only
    http_remux {
        enabled     off;
    }

    rtc {
        enabled     off;
    }

    play {
        gop_cache       on;
        mw_latency      1800;
    }

    # Transcode configuration - only applies to "ingress" app
    transcode ingress {
        enabled on;
        ffmpeg      ./objs/ffmpeg/bin/ffmpeg;

        # FHD 1080p - Full HD with high bitrate
        engine fhd {
            enabled on;
            vcodec libx264;
            vbitrate 6000;
            vfps 30;
            vwidth 1920;
            vheight 1080;
            vthreads 4;
            vprofile main;
            vpreset medium;
            vparams {
                g           60;     # GOP size: 2 seconds at 30fps for HLS
                bf          2;      # B-frames for better compression
                refs        3;      # Reference frames
            }
            acodec aac;
            abitrate 192;
            asample_rate 48000;
            achannels 2;
            aparams {
            }
            # Output to "live" app in same vhost
            output rtmp://127.0.0.1:[port]/live/[stream]_fhd;
        }

        # HD 720p
        engine hd {
            enabled on;
            vcodec libx264;
            vbitrate 3000;
            vfps 30;
            vwidth 1280;
            vheight 720;
            vthreads 2;
            vprofile main;
            vpreset faster;
            vparams {
                g           60;     # GOP size: 2 seconds at 30fps for HLS
                bf          2;      # B-frames for better compression
            }
            acodec aac;
            abitrate 160;
            asample_rate 48000;
            achannels 2;
            aparams {
            }
            # Output to "live" app in same vhost
            output rtmp://127.0.0.1:[port]/live/[stream]_hd;
        }

        # SD 480p
        engine sd {
            enabled on;
            vcodec libx264;
            vbitrate 1500;
            vfps 30;
            vwidth 854;
            vheight 480;
            vthreads 2;
            vprofile baseline;
            vpreset veryfast;
            vparams {
                g           60;     # GOP size: 2 seconds at 30fps for HLS
            }
            acodec aac;
            abitrate 128;
            asample_rate 48000;
            achannels 2;
            aparams {
            }
            # Output to "live" app in same vhost
            output rtmp://127.0.0.1:[port]/live/[stream]_sd;
        }

        # LD 360p - DISABLED (removed from player)
        engine ld {
            enabled off;
            vcodec libx264;
            vbitrate 500;
            vfps 30;
            vwidth 640;
            vheight 360;
            vthreads 2;
            vprofile baseline;
            vpreset veryfast;
            vparams {
                g           60;     # GOP size: 2 seconds at 30fps for HLS
            }
            acodec aac;
            abitrate 64;
            asample_rate 48000;
            achannels 2;
            aparams {
            }
            # Output to "live" app in same vhost
            output rtmp://127.0.0.1:[port]/live/[stream]_ld;
        }
    }
}
